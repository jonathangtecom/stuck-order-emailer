{% extends "ui/layout.html" %}

{% block title %}Template Editor — Stuck Order Emailer{% endblock %}

{% block content %}
<h2>Email Template Editor</h2>

<div class="editor-layout">
  <!-- Sidebar: file list -->
  <div class="editor-sidebar">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
      <strong>Templates</strong>
      <button class="outline" style="padding: 0.25rem 0.5rem; font-size: 0.8rem;" onclick="newTemplate()">+ New</button>
    </div>
    <ul class="file-list" id="file-list"></ul>
  </div>

  <!-- Main: editor + preview -->
  <div class="editor-main">
    <div style="margin-bottom: 0.5rem; display: flex; align-items: center; gap: 0.75rem;">
      <div id="editor-filename" style="font-weight: 600; color: var(--pico-muted-color);">
        No file selected
      </div>
      <span id="save-status" class="save-status" style="display: none; font-size: 0.85rem;"></span>
    </div>
    <div id="editor-container"></div>
    <div class="editor-actions">
      <button id="btn-save" onclick="saveFile()" disabled>Save</button>
      <button id="btn-preview" class="secondary" onclick="previewFile()" disabled>Preview</button>
      <button id="btn-test-email" class="secondary" onclick="openTestEmailModal()" disabled>Send Test Email</button>
      <button id="btn-duplicate" class="secondary outline" onclick="duplicateFile()" disabled>Duplicate</button>
      <button id="btn-delete" class="secondary outline" onclick="deleteFile()" disabled style="color: var(--pico-del-color, #c62828);">Delete</button>
    </div>
    <iframe id="preview-frame" class="preview-frame" sandbox="allow-same-origin" title="Email template preview" style="display: none;"></iframe>
  </div>
</div>

<!-- Test Email Modal -->
<dialog id="test-email-modal">
  <article>
    <header>
      <button aria-label="Close" rel="prev" onclick="closeTestEmailModal()"></button>
      <h3>Send Test Email</h3>
    </header>
    <form id="test-email-form" onsubmit="sendTestEmail(event)">
      <label>
        Recipient Email (your email)
        <input type="email" name="to_email" required placeholder="your@email.com">
      </label>
      <label>
        From Email
        <input type="email" name="from_email" required placeholder="support@yourstore.com">
        <small>Must be verified in SendGrid</small>
      </label>
      <label>
        From Name
        <input type="text" name="from_name" required placeholder="Your Store">
      </label>
      <label>
        Subject Line
        <input type="text" name="subject" required placeholder="Update on your order {{ order_number }}">
        <small>Supports Jinja2 variables</small>
      </label>
      <footer>
        <button type="button" class="secondary" onclick="closeTestEmailModal()">Cancel</button>
        <button type="submit">Send Test</button>
      </footer>
    </form>
  </article>
</dialog>

<!-- Toast notification -->
<div id="toast" class="toast" role="status" aria-live="polite"></div>
{% endblock %}

{% block scripts %}
<script type="module">
  import { EditorView, keymap } from 'https://esm.sh/@codemirror/view@6';
  import { EditorState } from 'https://esm.sh/@codemirror/state@6';
  import { html } from 'https://esm.sh/@codemirror/lang-html@6';
  import { defaultKeymap } from 'https://esm.sh/@codemirror/commands@6';
  import { history, historyKeymap } from 'https://esm.sh/@codemirror/history@6';
  import { lineNumbers, highlightActiveLineGutter } from 'https://esm.sh/@codemirror/gutter@6';
  import { highlightActiveLine } from 'https://esm.sh/@codemirror/view@6';
  import { syntaxHighlighting, defaultHighlightStyle } from 'https://esm.sh/@codemirror/language@6';

  const basicSetup = [
    lineNumbers(),
    highlightActiveLineGutter(),
    highlightActiveLine(),
    history(),
    syntaxHighlighting(defaultHighlightStyle),
    keymap.of([...defaultKeymap, ...historyKeymap])
  ];

  let editor = null;
  let currentFile = null;
  let isDirty = false;
  let lastSavedContent = '';
  let autosaveTimer = null;
  let isSaving = false;
  const AUTOSAVE_DELAY = 3000; // 3 seconds

  function initEditor(content) {
    const container = document.getElementById('editor-container');
    if (editor) editor.destroy();

    // Set lastSavedContent BEFORE creating editor to prevent race condition
    lastSavedContent = content || '';
    isDirty = false;

    editor = new EditorView({
      doc: content || '',
      extensions: [
        basicSetup,
        html(),
        EditorView.updateListener.of((update) => {
          if (update.docChanged) {
            markDirty();
          }
        }),
        EditorView.theme({
          '&': { height: '450px' },
          '.cm-scroller': { overflow: 'auto' },
        }),
      ],
      parent: container,
    });

    updateSaveStatus('saved');
  }

  function getEditorContent() {
    return editor ? editor.state.doc.toString() : '';
  }

  function updateSaveStatus(status) {
    const statusEl = document.getElementById('save-status');
    if (!statusEl || !currentFile) {
      if (statusEl) statusEl.style.display = 'none';
      return;
    }

    statusEl.style.display = 'inline';
    const messages = {
      'saved': '✓ Saved',
      'unsaved': '• Unsaved',
      'saving': '↻ Saving...',
      'error': '✗ Error'
    };
    statusEl.textContent = messages[status] || '';
    statusEl.className = `save-status ${status}`;
  }

  function markDirty() {
    const currentContent = getEditorContent();
    if (currentContent === lastSavedContent) {
      isDirty = false;
      updateSaveStatus('saved');
      return;
    }
    isDirty = true;
    updateSaveStatus('unsaved');
    // DISABLED: Autosave disabled until debugging is complete
    // scheduleAutosave();
  }

  function scheduleAutosave() {
    if (autosaveTimer) clearTimeout(autosaveTimer);
    autosaveTimer = setTimeout(() => {
      if (isDirty && !isSaving && currentFile) {
        performAutosave();
      }
    }, AUTOSAVE_DELAY);
  }

  async function performAutosave() {
    if (!currentFile || !isDirty || isSaving) return;

    const content = getEditorContent();

    // SAFETY: Never autosave if content is empty or too short (likely a bug)
    if (!content || content.trim().length < 10) {
      console.warn('Autosave blocked: content too short or empty:', content.length);
      return;
    }

    // SAFETY: Never autosave if content is different from what we loaded
    // (unless user actually typed something)
    if (content === '') {
      console.error('Autosave blocked: refusing to save empty content');
      return;
    }

    isSaving = true;
    updateSaveStatus('saving');

    try {
      const resp = await fetch(`/api/templates/${encodeURIComponent(currentFile)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content }),
      });

      if (!resp.ok) throw new Error('Autosave failed');

      lastSavedContent = content;
      isDirty = false;
      updateSaveStatus('saved');
    } catch (e) {
      console.error('Autosave error:', e);
      updateSaveStatus('error');
    } finally {
      isSaving = false;
    }
  }

  function showToast(message, type) {
    const toast = document.getElementById('toast');
    toast.textContent = message;
    toast.className = `toast show ${type}`;
    setTimeout(() => { toast.className = 'toast'; }, 3000);
  }

  function setButtonsEnabled(enabled) {
    document.getElementById('btn-save').disabled = !enabled;
    document.getElementById('btn-preview').disabled = !enabled;
    document.getElementById('btn-test-email').disabled = !enabled;
    document.getElementById('btn-duplicate').disabled = !enabled;
    document.getElementById('btn-delete').disabled = !enabled;
  }

  async function loadFileList() {
    try {
      const resp = await fetch('/api/templates');
      const data = await resp.json();
      const list = document.getElementById('file-list');
      list.innerHTML = '';

      for (const filename of data.templates) {
        const li = document.createElement('li');
        li.textContent = filename;
        li.onclick = () => loadFile(filename);
        if (filename === currentFile) li.classList.add('active');
        list.appendChild(li);
      }
    } catch (e) {
      console.error('Failed to load file list:', e);
    }
  }

  async function loadFile(filename) {
    // Check for unsaved changes before switching files
    if (isDirty && currentFile && currentFile !== filename) {
      if (!confirm('You have unsaved changes. Switch files without saving?')) {
        return;
      }
    }

    try {
      const resp = await fetch(`/api/templates/${encodeURIComponent(filename)}`);
      if (!resp.ok) throw new Error('Failed to load file');
      const data = await resp.json();

      currentFile = filename;
      document.getElementById('editor-filename').textContent = filename;
      initEditor(data.content);
      setButtonsEnabled(true);
      document.getElementById('preview-frame').style.display = 'none';
      loadFileList();
    } catch (e) {
      showToast('Failed to load file: ' + e.message, 'error');
    }
  }

  window.saveFile = async function() {
    if (!currentFile) return;

    // Cancel any pending autosave
    if (autosaveTimer) {
      clearTimeout(autosaveTimer);
      autosaveTimer = null;
    }

    isSaving = true;
    updateSaveStatus('saving');

    try {
      const content = getEditorContent();
      const resp = await fetch(`/api/templates/${encodeURIComponent(currentFile)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content }),
      });

      if (!resp.ok) throw new Error('Save failed');

      lastSavedContent = content;
      isDirty = false;
      updateSaveStatus('saved');
      showToast('Saved successfully', 'success');
    } catch (e) {
      updateSaveStatus('error');
      showToast('Failed to save: ' + e.message, 'error');
    } finally {
      isSaving = false;
    }
  };

  window.previewFile = async function() {
    try {
      const resp = await fetch('/api/templates/preview', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: getEditorContent() }),
      });
      if (!resp.ok) {
        const err = await resp.json();
        throw new Error(err.error || 'Preview failed');
      }
      const html = await resp.text();
      const iframe = document.getElementById('preview-frame');
      iframe.srcdoc = html;
      iframe.style.display = 'block';
    } catch (e) {
      showToast('Preview error: ' + e.message, 'error');
    }
  };

  window.newTemplate = async function() {
    const filename = prompt('Template filename (e.g. my-template.html):');
    if (!filename) return;

    const safeName = filename.endsWith('.html') ? filename : filename + '.html';
    try {
      const resp = await fetch(`/api/templates/${encodeURIComponent(safeName)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: '' }),
      });
      if (!resp.ok) throw new Error('Create failed');
      await loadFileList();
      await loadFile(safeName);
      showToast('Template created', 'success');
    } catch (e) {
      showToast('Failed to create template: ' + e.message, 'error');
    }
  };

  window.duplicateFile = async function() {
    if (!currentFile) return;
    const newName = prompt('New filename:', currentFile.replace('.html', '-copy.html'));
    if (!newName) return;

    const safeName = newName.endsWith('.html') ? newName : newName + '.html';
    try {
      const resp = await fetch(`/api/templates/${encodeURIComponent(safeName)}`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ content: getEditorContent() }),
      });
      if (!resp.ok) throw new Error('Duplicate failed');
      await loadFileList();
      await loadFile(safeName);
      showToast('Template duplicated', 'success');
    } catch (e) {
      showToast('Failed to duplicate: ' + e.message, 'error');
    }
  };

  window.deleteFile = async function() {
    if (!currentFile) return;
    if (!confirm(`Delete template "${currentFile}"?`)) return;

    try {
      const resp = await fetch(`/api/templates/${encodeURIComponent(currentFile)}`, {
        method: 'DELETE',
      });
      if (!resp.ok) throw new Error('Delete failed');

      currentFile = null;
      document.getElementById('editor-filename').textContent = 'No file selected';
      if (editor) editor.destroy();
      editor = null;
      isDirty = false;
      lastSavedContent = '';
      if (autosaveTimer) clearTimeout(autosaveTimer);
      setButtonsEnabled(false);
      updateSaveStatus('saved');
      document.getElementById('preview-frame').style.display = 'none';
      await loadFileList();
      showToast('Template deleted', 'success');
    } catch (e) {
      showToast('Failed to delete: ' + e.message, 'error');
    }
  };

  window.openTestEmailModal = function() {
    document.getElementById('test-email-modal').showModal();
  };

  window.closeTestEmailModal = function() {
    document.getElementById('test-email-modal').close();
  };

  window.sendTestEmail = async function(event) {
    event.preventDefault();
    const form = event.target;
    const formData = new FormData(form);

    const payload = {
      content: getEditorContent(),
      to_email: formData.get('to_email'),
      from_email: formData.get('from_email'),
      from_name: formData.get('from_name'),
      subject: formData.get('subject'),
    };

    try {
      const resp = await fetch('/api/templates/send-test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload),
      });

      const result = await resp.json();

      if (!resp.ok) {
        throw new Error(result.error || 'Send failed');
      }

      closeTestEmailModal();
      form.reset();
      showToast(result.message || 'Test email sent successfully!', 'success');
    } catch (e) {
      showToast('Failed to send test email: ' + e.message, 'error');
    }
  };

  // Warn before leaving page with unsaved changes
  window.addEventListener('beforeunload', (e) => {
    if (isDirty && currentFile) {
      e.preventDefault();
      e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
      return e.returnValue;
    }
  });

  // Initialize
  initEditor('');
  loadFileList().then(() => {
    // Auto-load first file if available
    const firstItem = document.querySelector('#file-list li');
    if (firstItem) firstItem.click();
  });
</script>
{% endblock %}
